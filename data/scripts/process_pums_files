#!/bin/bash
set -eux

arg=$1 # required argument to transform_pums_data script; gets passed straight through
pums_dir=$2
output_file=$3

tmp_dir=$(mktemp -d -t ci-XXXXXXXXXX)

files="$pums_dir/psam_p*.csv"

for file in $files
do
  filename="$(basename $file | cut -d"." -f1)"
  echo "Processing PUMS $filename.csv..."
  ./transform_pums_data $arg < $pums_dir/$filename.csv > $tmp_dir/$filename.json
  echo "JSON file saved to $tmp_dir/$filename.json"
done

echo "Joining JSON files..."
jq -s 'add' $tmp_dir/psam_p*.json > $output_file
echo "Output JSON saved to $output_file"
