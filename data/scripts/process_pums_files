#!/bin/bash
set -eux

arg=$1 # required argument to transform_pums_data script; gets passed straight through
pums_dir=$2
output_file=$3

tmp_dir=$(mktemp -d -t ci-XXXXXXXXXX)

# Save JSON with speaker counts grouped by state and PUMA to a file
declare -a files=("psam_pusa" "psam_pusb" "psam_pusc" "psam_pusd")

for file in "${files[@]}"
do
  echo "Processing PUMS $file.csv..."
  ./transform_pums_data $arg < $pums_dir/$file.csv > $tmp_dir/$file.json
  echo "JSON file saved to $tmp_dir/$file.json"
done

echo "Joining JSON files..."
jq -s 'add' $tmp_dir/psam_pus*.json > $output_file
echo "Output JSON saved to $output_file"
