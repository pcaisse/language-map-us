<html>
  <head>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
      integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
      integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
      crossorigin=""></script>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.10/lodash.min.js"></script>
    <link rel="stylesheet" href="static/css/main.css" />
  </head>
  <body>
    <!-- <div id="filters"> -->
    <!--   <div> -->
    <!--     <fieldset> -->
    <!--       <legend>Language Spoken at Home</legend> -->
    <!--       <select id="language"></select> -->
    <!--     </fieldset> -->
    <!--   </div> -->
    <!--   <div> -->
    <!--     <fieldset> -->
    <!--       <legend>Age</legend> -->
    <!--       <label for="age_from">From</label> -->
    <!--       <select id="age_from"></select> -->
    <!--       <label for="age_to">to</label> -->
    <!--       <select id="age_to"></select> -->
    <!--       years old -->
    <!--     </fieldset> -->
    <!--   </div> -->
    <!--   <div> -->
    <!--     <fieldset> -->
    <!--       <legend>English Speaking Ability</legend> -->
    <!--       <select id="english"></select> -->
    <!--     </fieldset> -->
    <!--   </div> -->
    <!--   <div> -->
    <!--     <fieldset> -->
    <!--       <legend>Citizenship Status</legend> -->
    <!--       <select id="citizenship"></select> -->
    <!--     </fieldset> -->
    <!--   </div> -->
    <!-- </div> -->
    <!-- <div id="legend"> -->
    <!--   <span>Percentage of speakers in area</span> -->
    <!--   <ul id="legend-items"> -->
    <!--   </ul> -->
    <!-- </div> -->
    <!-- Loading spinner -->
    <!-- <div class="loader"></div> -->

    <div id="elm"></div>

    <script type="text/javascript" src="static/elm/js/elm.js"></script>
    <script>
      var app = Elm.Main.embed(document.getElementById("elm"));

      app.ports.initializeMap.subscribe(function(data) {
        // Initialize map with appropriate bounding box and zoom level
        var map = L.map('map', {
          zoomControl: false,
          maxBounds: [
            [-90, -180],
            [90, 180]
          ],
          minZoom: 4
        }).fitBounds(
          [
            [data.boundingBox.southwestLat, data.boundingBox.southwestLng],
            [data.boundingBox.northeastLat, data.boundingBox.northeastLng],
          ]
        ).setZoom(data.zoomLevel);
        // Add tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        // Listen for changes to map
        map.on('moveend', _.debounce(function() {
          app.ports.mapPosition.send({
            boundingBoxString: map.getBounds().toBBoxString(),
            zoomLevel: map.getZoom()
          });
        }, 1000, {
          leading: false,
          trailing: true
        }));
      });

      app.ports.updateUrl.subscribe(function(data) {
        window.history.pushState(
          data,
          "Map Refresh",
          window.location.origin + window.location.pathname + "?" + $.param(data)
        );
      });
    </script>
  </body>
</html>
